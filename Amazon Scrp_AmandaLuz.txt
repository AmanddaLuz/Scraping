import pandas as pd
import time
import openpyxl
import requests
import lxml
from os import path
from bs4 import BeautifulSoup
from selenium import webdriver #caso utilize o Firefox baixar o geckodriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.keys import Keys

while True:
    print('ESCOPO DO PROJETO')
    print('#Abrir navegador em background')

    options = webdriver.ChromeOptions()
    options.add_argument("--headless")
    navegador = webdriver.Chrome(options=options)
    #navegador = webdriver.Chrome() CASO QUEIRA VER O NAVEGADOR ABERTO, TROQUE A OPÇÃO ANTERIOR POR ESTA.
    #navegador = webdriver.Firefox() 

    print('#Acessar a Amazon, fazer a busca por Iphone')
    navegador.get('https://www.amazon.com.br/')
    navegador.find_element_by_xpath('//*[@id="twotabsearchtextbox"]').send_keys('Iphone' + Keys.RETURN)
    time.sleep(1) #pausas para garantir o carregamento da página

    print('#Obtém a URL do resultado')
    linkBusca = navegador.current_url
    print(linkBusca)

    print('#Capturar o conteúdo da página')
    res = requests.get(linkBusca)
    res.encoding = 'utf-8'
    time.sleep(2)

    soup = BeautifulSoup(res.text, 'html.parser')
    print('#Segmenta o conteudo obtido')
    #soup = BeautifulSoup(res.text, 'html.parser')
    time.sleep(2)

    print('#Montagem da tabela com os produtos da primeira página')
    planilha = []
    produto = soup.find_all(class_ = 'a-section a-spacing-medium')
    
    if not produto:
        print('FALHA NO SITE PESQUISADO! Tentando novamente!')
        navegador.quit()
        continue
    else:
        break

for a in produto:
    info = a.find(class_ = 'a-section a-spacing-none')
    title = info.h2.text
    preco = info.find(class_ = 'a-offscreen')
    if preco:
        planilha.append({'NOME':title,'PRECO':preco.text})
    else:
        planilha.append({'NOME':title, 'PRECO':'Indisponível'})
#
time.sleep(1)
print('#Obtém diretório para salvar o arquivo xlsx')
pastaUsuario = path.join(path.expanduser('~'))

print('#Gera a planilha a partir dos dados obtidos usando um dataframe e depois convertendo em excel')
df=pd.DataFrame(data=planilha)
df
df.to_excel(pastaUsuario+'\DadosAmazon.xlsx', index=False)
print('Planilha salva com sucesso no diretório - ' + pastaUsuario + '\DadosAmazon.xlsx')


print('#Fechando navegador')
navegador.quit()

print('#Abrindo a planilha e lançando para a tela')
Dados = pd.read_excel(pastaUsuario+'\DadosAmazon.xlsx')
display(Dados)

